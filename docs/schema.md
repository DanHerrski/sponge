# Sponge MVP — Database Schema (P0)

Reference: [`steel-thread.md`](./steel-thread.md) | [`mvp_spec.md`](../mvp_spec.md) §5, §13.1 | [`technical-decisions.md`](./technical-decisions.md) Decisions 1–2

All tables reside in PostgreSQL 16 with the pgvector extension. Managed via Alembic migrations.

---

## Table: sessions

**Purpose:** Group chat turns and knowledge graph data into a user session/project.

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `project_name` | `VARCHAR(255)` | ✅ | User-provided during onboarding |
| `topic` | `TEXT` | ✅ | Freeform topic description |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |
| `updated_at` | `TIMESTAMPTZ` | ✅ | Auto-updated |
| _`audience`_ | _`TEXT`_ | ❌ P1 | _Optional audience description_ |
| _`tone`_ | _`VARCHAR(100)`_ | ❌ P1 | _Preferred style/tone_ |

**Indexes:** None beyond PK (sessions are accessed by ID).

---

## Table: chat_turns

**Purpose:** Store the ordered conversation history for a session (user messages and assistant responses).

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `session_id` | `UUID` FK → sessions | ✅ | `ON DELETE CASCADE` |
| `turn_number` | `INTEGER` | ✅ | Sequential within session |
| `role` | `ENUM('user', 'assistant')` | ✅ | |
| `content` | `TEXT` | ✅ | Raw message text |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |
| _`response_metadata`_ | _`JSONB`_ | ❌ P1 | _Latency, model used, token counts_ |

**Indexes:**
- `ix_chat_turns_session_turn` on `(session_id, turn_number)` — ordered retrieval

---

## Table: nodes

**Purpose:** Knowledge graph nodes representing extracted ideas, stories, frameworks, definitions, evidence, and themes.

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `session_id` | `UUID` FK → sessions | ✅ | `ON DELETE CASCADE` |
| `node_type` | `ENUM('idea', 'story', 'framework', 'definition', 'evidence', 'theme')` | ✅ | Spec §5.1 |
| `title` | `VARCHAR(500)` | ✅ | Auto-generated by LLM |
| `summary` | `TEXT` | ✅ | 1–3 sentence summary |
| `embedding` | `VECTOR(1536)` | ✅ | OpenAI text-embedding-3-small |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |
| _`key_phrases`_ | _`JSONB`_ | ❌ P1 | _Extracted key phrases for search_ |

**Indexes:**
- `ix_nodes_session` on `(session_id)` — filter by session
- HNSW index on `embedding` using `vector_cosine_ops` — similarity search for dedup/retrieval

---

## Table: edges

**Purpose:** Directed relationships between knowledge graph nodes.

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `session_id` | `UUID` FK → sessions | ✅ | `ON DELETE CASCADE` |
| `source_id` | `UUID` FK → nodes | ✅ | `ON DELETE CASCADE` |
| `target_id` | `UUID` FK → nodes | ✅ | `ON DELETE CASCADE` |
| `edge_type` | `ENUM('supports', 'example_of', 'expands_on', 'related_to', 'contradicts')` | ✅ | Spec §5.2 |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |
| _`weight`_ | _`FLOAT`_ | ❌ P1 | _Edge strength/confidence_ |

**Indexes:**
- `ix_edges_source` on `(source_id)` — outbound traversal
- `ix_edges_target` on `(target_id)` — inbound traversal
- `ix_edges_session_type` on `(session_id, edge_type)` — filtered graph view

---

## Table: nuggets

**Purpose:** Prioritization wrapper around high-value nodes. Stores scoring, gap analysis, and status.

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `node_id` | `UUID` FK → nodes | ✅ | `ON DELETE CASCADE`, UNIQUE |
| `nugget_type` | `ENUM('idea', 'story', 'framework')` | ✅ | Subset of node types |
| `title` | `VARCHAR(500)` | ✅ | May differ from node title |
| `short_summary` | `TEXT` | ✅ | Brief description |
| `score` | `INTEGER` | ✅ | NuggetScore 0–100 |
| `dimension_scores` | `JSONB` | ✅ | `{specificity, novelty, authority, actionability, story_energy, audience_resonance}` |
| `missing_fields` | `JSONB` | ✅ | `["example", "evidence", ...]` |
| `next_questions` | `JSONB` | ✅ | Ranked list of question strings |
| `status` | `ENUM('new', 'explored', 'parked')` | ✅ | Default: `'new'` |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |
| _`suggested_formats`_ | _`JSONB`_ | ❌ P1 | _`["post", "chapter", "talk"]`_ |

**Indexes:**
- `ix_nuggets_node` on `(node_id)` — join to nodes (unique)

---

## Table: provenance

**Purpose:** Track where each node originated — which chat turn or uploaded document.

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `node_id` | `UUID` FK → nodes | ✅ | `ON DELETE CASCADE` |
| `source_type` | `ENUM('chat', 'upload')` | ✅ | |
| `source_id` | `UUID` | ✅ | References chat_turns.id or documents.id |
| `confidence` | `ENUM('low', 'med', 'high')` | ✅ | Extraction confidence |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |

**Indexes:**
- `ix_provenance_node` on `(node_id)` — join to nodes

---

## Table: documents

**Purpose:** Metadata for uploaded files. Actual files stored on local filesystem (see technical-decisions.md Decision 6).

| Field | Type | Steel Thread | Notes |
|-------|------|:---:|-------|
| `id` | `UUID` PK | ✅ | Default: `gen_random_uuid()` |
| `session_id` | `UUID` FK → sessions | ✅ | `ON DELETE CASCADE` |
| `filename` | `VARCHAR(500)` | ✅ | Original filename |
| `content_type` | `VARCHAR(100)` | ✅ | MIME type |
| `storage_path` | `TEXT` | ✅ | Path in FileStore |
| `size_bytes` | `INTEGER` | ✅ | |
| `created_at` | `TIMESTAMPTZ` | ✅ | Default: `now()` |
| _`chunk_count`_ | _`INTEGER`_ | ❌ P1 | _Number of chunks extracted_ |
| _`status`_ | _`VARCHAR(50)`_ | ❌ P1 | _Processing status_ |

**Indexes:**
- `ix_documents_session` on `(session_id)` — filter by session

---

## Enum Types

```sql
CREATE TYPE node_type AS ENUM ('idea', 'story', 'framework', 'definition', 'evidence', 'theme');
CREATE TYPE edge_type AS ENUM ('supports', 'example_of', 'expands_on', 'related_to', 'contradicts');
CREATE TYPE nugget_type AS ENUM ('idea', 'story', 'framework');
CREATE TYPE nugget_status AS ENUM ('new', 'explored', 'parked');
CREATE TYPE chat_role AS ENUM ('user', 'assistant');
CREATE TYPE source_type AS ENUM ('chat', 'upload');
CREATE TYPE confidence_level AS ENUM ('low', 'med', 'high');
```

---

## Entity Relationship Summary

```
sessions 1──* chat_turns
sessions 1──* nodes
sessions 1──* edges
sessions 1──* documents
nodes    1──* edges (as source)
nodes    1──* edges (as target)
nodes    1──1 nuggets
nodes    1──* provenance
```
